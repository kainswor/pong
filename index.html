<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <title>Pong - Retro CRT Game</title> <meta name="description" content="Classic Pong game with retro CRT pixel display effects"> <style>*{margin:0;padding:0;box-sizing:border-box}body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:#000;font-family:monospace}#display{display:block;image-rendering:pixelated;image-rendering:crisp-edges}</style> </head> <body> <canvas id="display"></canvas> <script> const __DEBUG_SCREENS_ENABLED__=!1,GOALS_TO_WIN=5,COUNTDOWN_MS=750,LOGIC_HZ=60,DT_MS=16.666666666666668,MAX_FRAME_MS=200,MAX_UPDATES_PER_FRAME=5,PADDLE_WIDTH=2,PADDLE_HEIGHT=14,PADDLE_SPEED=1.8,BALL_SPEED=1,PADDLE_EDGE_OFFSET=2,SPEED_INCREASE_PER_VOLLEY=.0025,MAX_SPEED_MULTIPLIER=2,BUTTON_SIZE=20,BUTTON_PADDING=30,BUTTON_PADDING_V=25,BLINK_SPEED=.0025,BLINK_CACHE_MS=16,BLINK_ON_THRESHOLD=.7,TRIANGLE_OFFSET=3,TRIANGLE_EXTRA=3,SMALL_TRIANGLE_LONG_SIDE=10,SMALL_TRIANGLE_HEIGHT=6,SCALE_1P=17/12,SCALE_2P_DIGIT=6/5,GAME_OVER_TEXT_SCALE=1.26,GAME_OVER_CHAR_WIDTH=10,GAME_OVER_BOUNCE_SPEED=.003,GAME_OVER_BOUNCE_AMOUNT=3,GAME_OVER_BASE_Y_OFFSET=28,GAME_OVER_WINNER_X_OFFSET=1,GAME_OVER_LOSE_X_OFFSET=3,LABEL_SCALE=2,LABEL_GLYPH_COLS=7,LABEL_GAP_W=4,LABEL_BOUNCE_SPEED=.003,LABEL_BOUNCE_AMOUNT=3,PAUSE_BOUNCE_SPEED=.005,PAUSE_BOUNCE_AMOUNT=.3,PAUSE_BAR_WIDTH=3,PAUSE_BAR_HEIGHT=12,PAUSE_BAR_SPACING=2,RESTART_ARROW_RADIUS=6,RESTART_ARROW_SPEED=.1,SPIN_PADDLE_TRANSFER_LEVEL=[.1,.2,.36],SPIN_PADDLE_TRANSFER_2P=.2,SPIN_MAGNUS_FACTOR_LEVEL=[.012,.0224,.0405],SPIN_MAGNUS_FACTOR_2P=.0224,SPIN_DAMPING_PER_TICK=.997,SPIN_WALL_RETENTION_LEVEL=[.6,.6,.81],SPIN_WALL_RETENTION_2P=.6,SPIN_MAX=2,LEVEL_SPEED_FACTOR_3=1.1,KEY_DEGAUSS=" ",KEY_ENTER="Enter",KEY_PAUSE=["p","P"],KEY_MENU_UP=["ArrowUp","w","W"],KEY_MENU_DOWN=["ArrowDown","s","S"],KEY_DEBUG_WIN=["o","O"],KEY_DEBUG_LOSE=["l","L"],KEY_DEBUG_1="1",KEY_DEBUG_2="2",UP_KEYS_1P=["ArrowUp","w","W"],DOWN_KEYS_1P=["ArrowDown","s","S"],UP_KEYS_LEFT_2P=["w","W"],DOWN_KEYS_LEFT_2P=["s","S"],UP_KEYS_RIGHT_2P=["ArrowUp"],DOWN_KEYS_RIGHT_2P=["ArrowDown"],CRT_ON_COLOR="#39ff14",CRT_FADE_IN_MS=50,CRT_FADE_OUT_MS=200,DEGAUSS_COOLDOWN_MS=3e4,DEGAUSS_COOLDOWN_MIN_MS=1e3,DEGAUSS_DURATION_BASE_MS=2e3,DEGAUSS_AMP_PX=12,DEGAUSS_OVERLAY_ALPHA=.35,DEGAUSS_DECAY_ALPHA=2.5,DEGAUSS_FREQ_HZ=50,DEGAUSS_WAVE_K=2.5;class PixelDisplay{constructor(t,i=300,e=200,h=800,s=600,a=60){this.canvas=t,this.ctx=t.getContext("2d"),this.emulatedWidth=i,this.emulatedHeight=e,this.displayWidth=h,this.displayHeight=s,this.refreshHz=a,this.targetIntervalMs=1e3/a,this.canvas.width=h,this.canvas.height=s,this.gapWidth=1,this.gapHeight=1,this.pixelWidth=(h-(i-1)*this.gapWidth)/i,this.pixelHeight=(s-(e-1)*this.gapHeight)/e,this.onColor=CRT_ON_COLOR,this.fadeInTime=CRT_FADE_IN_MS,this.fadeOutTime=CRT_FADE_OUT_MS,this.pixels=[];for(let o=0;o<e;o++){this.pixels[o]=[];for(let r=0;r<i;r++)this.pixels[o][r]={state:!1,onTimestamp:0,offTimestamp:0}}this._now=void 0,this.lastDegaussEndTime=0,this.degaussStartTime=0,this.degaussDuration=0,this.degaussStrength=0,this.DEGAUSS_COOLDOWN_MS=DEGAUSS_COOLDOWN_MS,this.DEGAUSS_COOLDOWN_MIN_MS=DEGAUSS_COOLDOWN_MIN_MS,this.DEGAUSS_DURATION_BASE_MS=DEGAUSS_DURATION_BASE_MS,this.DEGAUSS_AMP_PX=DEGAUSS_AMP_PX,this.DEGAUSS_OVERLAY_ALPHA=DEGAUSS_OVERLAY_ALPHA,this.DEGAUSS_DECAY_ALPHA=DEGAUSS_DECAY_ALPHA,this.DEGAUSS_FREQ_HZ=DEGAUSS_FREQ_HZ,this.DEGAUSS_WAVE_K=DEGAUSS_WAVE_K}setPixel(t,i,e){if(t>=0&&t<this.emulatedWidth&&i>=0&&i<this.emulatedHeight){const h=this.pixels[i][t],s=this.getTime();h.state!==e&&(h.state=e,e?h.onTimestamp=s:h.offTimestamp=s)}}getPixel(t,i){return t>=0&&t<this.emulatedWidth&&i>=0&&i<this.emulatedHeight?this.pixels[i][t].state:!1}setTime(t){this._now=t}getTime(){return this._now!==void 0?this._now:performance.now()}toASCII(t,i,e,h){const s=Math.max(0,Math.min(t,this.emulatedWidth)),a=Math.max(0,Math.min(i,this.emulatedHeight)),o=Math.min(this.emulatedWidth,s+Math.max(0,e)),r=Math.min(this.emulatedHeight,a+Math.max(0,h)),c=[];for(let l=a;l<r;l++){let d="";for(let n=s;n<o;n++)d+=this.pixels[l][n].state?"#":".";c.push(d)}return c.join(`
`)}getPixelRegion(t,i,e,h){const s=Math.max(0,Math.min(t,this.emulatedWidth)),a=Math.max(0,Math.min(i,this.emulatedHeight)),o=Math.min(this.emulatedWidth,s+Math.max(0,e)),r=Math.min(this.emulatedHeight,a+Math.max(0,h)),c=[];for(let l=a;l<r;l++){const d=[];for(let n=s;n<o;n++)d.push(this.pixels[l][n].state);c.push(d)}return c}degauss(){const t=this.getTime();if(this.degaussStartTime!==0&&t-this.degaussStartTime<this.degaussDuration)return;const i=this.lastDegaussEndTime===0?this.DEGAUSS_COOLDOWN_MS:t-this.lastDegaussEndTime,e=Math.max(0,Math.min(1,(i-this.DEGAUSS_COOLDOWN_MIN_MS)/(this.DEGAUSS_COOLDOWN_MS-this.DEGAUSS_COOLDOWN_MIN_MS))),h=Math.pow(e,1.5);if(h<.01){this.lastDegaussEndTime=t;return}this.degaussStartTime=t,this.degaussDuration=this.DEGAUSS_DURATION_BASE_MS*h,this.degaussStrength=h}drawPattern(t,i,e,h=1){const s=Math.max(1,h),a=t.length;if(a===0)return;const o=t[0]?.length??0;if(o===0)return;const r=Math.max(1,Math.ceil(o*s)),c=Math.max(1,Math.ceil(a*s));for(let l=0;l<c;l++){const d=Math.min(a-1,Math.floor(l/s)),n=t[d];if(!(!n||!Array.isArray(n)))for(let u=0;u<r;u++){const f=Math.min(o-1,Math.floor(u/s));(n[f]===1||n[f]===!0)&&this.setPixel(Math.floor(i+u),Math.floor(e+l),!0)}}}drawRectOutline(t,i,e,h,s={}){const a=Math.floor(t),o=Math.floor(i),r=Math.floor(t+e)-1,c=Math.floor(i+h)-1,l=s.preserve,d=(n,u)=>l&&typeof l=="function"&&l(n,u);for(let n=a;n<=r;n++)d(n,o)||this.setPixel(n,o,!0);for(let n=a;n<=r;n++)d(n,c)||this.setPixel(n,c,!0);for(let n=o;n<=c;n++)d(a,n)||this.setPixel(a,n,!0);for(let n=o;n<=c;n++)d(r,n)||this.setPixel(r,n,!0)}drawRectFilled(t,i,e,h){const s=Math.max(0,Math.floor(t)),a=Math.max(0,Math.floor(i)),o=Math.min(this.emulatedWidth,s+Math.max(0,Math.floor(e))),r=Math.min(this.emulatedHeight,a+Math.max(0,Math.floor(h)));for(let c=a;c<r;c++)for(let l=s;l<o;l++)this.setPixel(l,c,!0)}drawLineH(t,i,e){const h=Math.floor(t);if(h<0||h>=this.emulatedHeight)return;const s=Math.min(Math.floor(i),Math.floor(e)),a=Math.max(Math.floor(i),Math.floor(e));for(let o=Math.max(0,s);o<=Math.min(this.emulatedWidth-1,a);o++)this.setPixel(o,h,!0)}drawLineV(t,i,e){const h=Math.floor(t);if(h<0||h>=this.emulatedWidth)return;const s=Math.min(Math.floor(i),Math.floor(e)),a=Math.max(Math.floor(i),Math.floor(e));for(let o=Math.max(0,s);o<=Math.min(this.emulatedHeight-1,a);o++)this.setPixel(h,o,!0)}drawLineVDashed(t,i,e,h=2){const s=Math.floor(t);if(s<0||s>=this.emulatedWidth)return;const a=Math.max(1,Math.floor(h)),o=Math.min(Math.floor(i),Math.floor(e)),r=Math.max(Math.floor(i),Math.floor(e));for(let c=o;c<=r;c+=a)c>=0&&c<this.emulatedHeight&&this.setPixel(s,c,!0)}clearRect(t,i,e,h,s={}){const a=this.getTime(),o=Math.max(0,Math.floor(t)),r=Math.max(0,Math.floor(i)),c=Math.min(this.emulatedWidth,o+Math.max(0,Math.floor(e))),l=Math.min(this.emulatedHeight,r+Math.max(0,Math.floor(h))),d=s.preserve;for(let n=r;n<l;n++)for(let u=o;u<c;u++)d&&typeof d=="function"&&d(u,n)||(this.pixels[n][u].state=!1,this.pixels[n][u].offTimestamp=a)}clear(){const t=this.getTime(),i=t-this.fadeOutTime-1;for(let e=0;e<this.emulatedHeight;e++)for(let h=0;h<this.emulatedWidth;h++){const s=this.pixels[e][h];s.state?s.offTimestamp=t:s.offTimestamp=i,s.state=!1}}calculateBrightness(t,i){let e=0,h=0;if(t.onTimestamp>0){const s=i-t.onTimestamp;t.state&&(s<this.fadeInTime?e=s/this.fadeInTime:e=1)}if(t.offTimestamp>0){const s=i-t.offTimestamp;if(t.state){if(s<this.fadeOutTime){const a=s/this.fadeOutTime;h=Math.pow(1-a,6)}}else if(s<this.fadeOutTime){const a=s/this.fadeOutTime;h=Math.pow(1-a,6)}else h=0}return Math.min(1,Math.max(e,h))}render(t,i){const e=i&&i.now!=null?i.now:this.getTime(),h=i&&i.dtSinceLastRender!=null?i.dtSinceLastRender:0;this.driftMs=h-this.targetIntervalMs,this.effectiveDt=Math.min(h,2*this.targetIntervalMs);const s=e;this.degaussStartTime!==0&&s-this.degaussStartTime>=this.degaussDuration&&(this.degaussStartTime=0,this.lastDegaussEndTime=s);const a=this.degaussStartTime!==0;let o=0,r=0,c=0,l=0,d=0,n=0;a&&(r=(s-this.degaussStartTime)/1e3,c=Math.exp(-this.DEGAUSS_DECAY_ALPHA*r),o=c*this.degaussStrength*this.DEGAUSS_OVERLAY_ALPHA,l=this.DEGAUSS_FREQ_HZ,d=this.DEGAUSS_WAVE_K,n=this.DEGAUSS_AMP_PX*this.degaussStrength);const u=parseInt(this.onColor.substring(1,3),16),f=parseInt(this.onColor.substring(3,5),16),m=parseInt(this.onColor.substring(5,7),16);if(this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.displayWidth,this.displayHeight),a){const g=this.pixelWidth+this.gapWidth,y=this.pixelHeight+this.gapHeight;for(let E=0;E<this.emulatedHeight;E++)for(let M=0;M<this.emulatedWidth;M++){const _=M*g,p=E*y,S=_/this.displayWidth,P=p/this.displayHeight,v=Math.sqrt((S-.5)**2+(P-.5)**2)*2,A=.4+.6*Math.min(1,v),G=n*A*c*Math.sin(2*Math.PI*l*r+2*Math.PI*d*S),w=n*A*c*Math.sin(2*Math.PI*l*r+Math.PI/2+2*Math.PI*d*P),x=(_-G)/g,b=(p-w)/y,L=Math.max(0,Math.min(this.emulatedWidth-1,Math.floor(x))),T=Math.max(0,Math.min(this.emulatedHeight-1,Math.floor(b))),O=this.pixels[T][L],R=this.calculateBrightness(O,s);R>0&&(this.ctx.fillStyle=`rgba(${u}, ${f}, ${m}, ${R})`,this.ctx.fillRect(_,p,this.pixelWidth,this.pixelHeight))}}else for(let g=0;g<this.emulatedHeight;g++)for(let y=0;y<this.emulatedWidth;y++){const E=this.pixels[g][y],M=this.calculateBrightness(E,s);if(M>0){const _=y*(this.pixelWidth+this.gapWidth),p=g*(this.pixelHeight+this.gapHeight);this.ctx.fillStyle=`rgba(${u}, ${f}, ${m}, ${M})`,this.ctx.fillRect(_,p,this.pixelWidth,this.pixelHeight)}}a&&(this.ctx.fillStyle=`rgba(255, 0, 255, ${o})`,this.ctx.fillRect(0,0,this.displayWidth,this.displayHeight))}}const PIXEL_FONT={0:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],1:[[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,1,1,0]],2:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],3:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1],[1,1,1,1,1]],4:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1],[0,0,0,0,1]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1],[1,1,1,1,1]],6:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],7:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1],[0,0,0,0,1],[0,0,0,0,1],[0,0,0,0,1],[0,0,0,0,1]],8:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],9:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1],[1,1,1,1,1]]},LARGE_LETTER_PATTERNS={1:[[0,0,1,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,1,1,1,1,1,0]],2:[[0,1,1,1,1,1,0],[1,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,1,0],[0,0,0,0,1,0,0],[0,0,0,1,0,0,0],[0,0,1,0,0,0,0],[0,1,0,0,0,0,0],[1,1,1,1,1,1,1]],W:[[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,1,0,0,1],[1,0,1,0,1,0,1],[1,1,0,0,0,1,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1]],I:[[1,1,1,1,1,1,1],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[1,1,1,1,1,1,1]],N:[[1,0,0,0,0,0,1],[1,1,0,0,0,0,1],[1,0,1,0,0,0,1],[1,0,0,1,0,0,1],[1,0,0,0,1,0,1],[1,0,0,0,0,1,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1]],E:[[1,1,1,1,1,1,1],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,1,1,1,1,1,1],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,1,1,1,1,1,1]],R:[[1,1,1,1,1,1,0],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,1,1,1,1,1,0],[1,0,0,0,1,0,0],[1,0,0,0,0,1,0],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1]],"!":[[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0]],Y:[[1,0,0,0,0,0,1],[0,1,0,0,0,1,0],[0,0,1,0,1,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0]],O:[[0,1,1,1,1,1,0],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[0,1,1,1,1,1,0]],U:[[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[0,1,1,1,1,1,0]],L:[[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,1,1,1,1,1,1]],S:[[0,1,1,1,1,1,0],[1,0,0,0,0,0,1],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[0,1,1,1,1,1,0],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[1,0,0,0,0,0,1],[0,1,1,1,1,1,0]],P:[[1,1,1,1,1,1,0],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,1,1,1,1,1,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0]],G:[[0,1,1,1,1,1,0],[1,0,0,0,0,0,1],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,0,0,1,1,1,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[0,1,1,1,1,1,0]]};class PlayerController{update(t,i,e){return null}}class KeyboardController extends PlayerController{constructor(t={}){super();const i=t.upKeys??["ArrowUp","w","W"],e=t.downKeys??["ArrowDown","s","S"];this.keys={};for(const h of i)this.keys[h]=!1;for(const h of e)this.keys[h]=!1;this._upKeys=i,this._downKeys=e,typeof document<"u"&&(document.addEventListener("keydown",h=>{this.keys.hasOwnProperty(h.key)&&(h.preventDefault(),this.keys[h.key]=!0)}),document.addEventListener("keyup",h=>{this.keys.hasOwnProperty(h.key)&&(h.preventDefault(),this.keys[h.key]=!1)}))}update(t,i,e){return this._upKeys.some(h=>this.keys[h])?"up":this._downKeys.some(h=>this.keys[h])?"down":null}}class AIController extends PlayerController{constructor(t=.5){super(),this.skill=t,this.targetY=0,this.currentVelocity=0,this.lastDirection=0,this.directionChangeTime=0,this.reactionDelay=0,this.reacting=!1,this.lastDegaussStartTime=0,this.shakenOffActive=!1,this.maxReactionTime=500,this.minReactionTime=150,this.maxAccelRate=.016875,this.minAccelRate=.005625,this.smoothingFactor=.15}update(t,i,e){if(e.degaussStartTime===0&&(this.lastDegaussStartTime=0),e.degaussStartTime>0&&e.degaussDuration>0){const u=(e.currentTime-e.degaussStartTime)/e.degaussDuration;if(e.degaussStartTime!==this.lastDegaussStartTime&&(this.lastDegaussStartTime=e.degaussStartTime,e.aiDifficultyLevel===1?this.shakenOffActive=Math.random()<.75:e.aiDifficultyLevel===2?this.shakenOffActive=Math.random()<.5:this.shakenOffActive=!1),this.shakenOffActive)if(u>=.8)this.shakenOffActive=!1,this.reacting=!1,this.lastDirection=i.vy>0?1:i.vy<0?-1:0;else{const f=t.speed*.71;if(u<.4){const m=this.currentVelocity>=0?-f:f;this.currentVelocity+=(m-this.currentVelocity)*this.smoothingFactor}else this.currentVelocity+=(0-this.currentVelocity)*(this.smoothingFactor*.5);return this.currentVelocity=Math.max(-f,Math.min(f,this.currentVelocity)),t.y+=this.currentVelocity,this.getDirectionFromVelocity()}}this.targetY=i.y;const h=i.vy>0?1:i.vy<0?-1:0;if(h!==this.lastDirection&&h!==0){this.reacting=!0,this.directionChangeTime=performance.now();const n=this.minReactionTime+(1-this.skill)*(this.maxReactionTime-this.minReactionTime),u=(Math.random()-.5)*1.6*n;this.reactionDelay=Math.max(0,n+u)}if(this.lastDirection=h,this.reacting){if(performance.now()-this.directionChangeTime<this.reactionDelay)return t.y+=this.currentVelocity,this.getDirectionFromVelocity();this.reacting=!1}const s=this.minAccelRate+this.skill*(this.maxAccelRate-this.minAccelRate),a=t.y+t.height/2,o=this.targetY-a,r=2,c=t.speed;let l=0;if(Math.abs(o)<r)l=0;else{const n=o>0?1:-1,u=Math.min(1,Math.abs(o)/20);l=n*c*u}this.currentVelocity+=(l-this.currentVelocity)*this.smoothingFactor;const d=c*.71;return this.currentVelocity=Math.max(-d,Math.min(d,this.currentVelocity)),t.y+=this.currentVelocity,this.getDirectionFromVelocity()}getDirectionFromVelocity(){return Math.abs(this.currentVelocity)<.1?null:this.currentVelocity>0?"down":"up"}}class Pong{constructor(t){this.display=t,this.width=t.emulatedWidth,this.height=t.emulatedHeight,this.PADDLE_WIDTH=PADDLE_WIDTH,this.PADDLE_HEIGHT=PADDLE_HEIGHT,this.PADDLE_SPEED=PADDLE_SPEED,this.BALL_SPEED=BALL_SPEED,this.PADDLE_LEFT_X=PADDLE_EDGE_OFFSET,this.PADDLE_RIGHT_X=this.width-4,this.gameState="MENU",this.countdownNumber=3,this.countdownStartTime=0,this.winner=null,this.winning=!1,this.gameOverViaDebugKey=!1,this.debugGameOverVariant=null,this.gameOverStartTime=0,this.restartArrowRotation=0,this.restartArrowRotationSpeed=RESTART_ARROW_SPEED,this.pauseButtonScale=1,this.savedState=null,this.resumingFromPause=!1,this.volleyCount=0,this.currentSpeedMultiplier=1,this.rightPlayerOption=2,this.aiDifficultyLevel=2,this.player1FrameX=0,this.player1FrameY=0,this.player2FrameX=0,this.player2FrameY=0,this.startButtonFrameX=0,this.startButtonFrameY=0,this.pongTitleX=Math.floor(this.width/2),this.pongTitleY=Math.floor(this.height/2),this.pongTitleVx=(Math.random()>.5?1:-1)*.5,this.pongTitleVy=(Math.random()>.5?1:-1)*.5,this.leftPaddle={x:this.PADDLE_LEFT_X,y:Math.floor(this.height/2-this.PADDLE_HEIGHT/2),width:this.PADDLE_WIDTH,height:this.PADDLE_HEIGHT,speed:this.PADDLE_SPEED,_prevY:Math.floor(this.height/2-this.PADDLE_HEIGHT/2),vy:0},this.rightPaddle={x:this.PADDLE_RIGHT_X,y:Math.floor(this.height/2-this.PADDLE_HEIGHT/2),width:this.PADDLE_WIDTH,height:this.PADDLE_HEIGHT,speed:this.PADDLE_SPEED,_prevY:Math.floor(this.height/2-this.PADDLE_HEIGHT/2),vy:0},this.ball={x:Math.floor(this.width/2),y:Math.floor(this.height/2),vx:0,vy:0,spin:0,radius:1},this.score={left:0,right:0},this._keyboard1P=new KeyboardController({upKeys:UP_KEYS_1P,downKeys:DOWN_KEYS_1P}),this._keyboardLeft2P=new KeyboardController({upKeys:UP_KEYS_LEFT_2P,downKeys:DOWN_KEYS_LEFT_2P}),this._keyboardRight2P=new KeyboardController({upKeys:UP_KEYS_RIGHT_2P,downKeys:DOWN_KEYS_RIGHT_2P}),this._aiController=new AIController(.5),this.leftController=this._keyboard1P,this.rightController=this._aiController,this.startButtonBounds=null,this.restartButtonBounds=null,this.calculateMenuFramePositions(),this.setupClickHandler(),this.setupPauseHandler(),this._runStateUpdate={MENU:function(){this.drawMenu()},COUNTDOWN:function(){this.drawCountdown()},PAUSED:function(){this.drawPauseButton(),this.drawCurrentFrame()},GAME_OVER:function(){this.drawGameOver(),this.drawCurrentFrame()},PLAYING:function(){}}}calculateMenuFramePositions(){const t=Math.floor(this.width/2),i=Math.floor(this.height/2),e=BUTTON_SIZE,h=t/3,s=Math.floor(h),a=Math.floor(h*2);this.player1FrameX=s-Math.floor(e/2),this.player1FrameY=i-Math.floor(e/2),this.startButtonFrameX=a-Math.floor(e/2),this.startButtonFrameY=i-Math.floor(e/2);const o=this.width-s;this.player2FrameX=o-Math.floor(e/2),this.player2FrameY=i-Math.floor(e/2)}maintainCourt(){const t=Math.floor(this.width/2);this.display.drawLineVDashed(t,0,this.height-1,2),this.display.drawLineH(0,0,this.width-1),this.display.drawLineH(this.height-1,0,this.width-1),this.updateScores()}drawNumber(t,i,e,h=1){const s=PIXEL_FONT[e];s&&this.display.drawPattern(s,t,i,Math.max(1,h))}updateScores(){this.drawNumber(2,2,this.score.left),this.drawNumber(this.width-7,2,this.score.right)}drawCountdown(){const t=this.display.getTime&&this.display.getTime()||performance.now(),i=t-this.countdownStartTime,e=750;if(i>=e&&(this.countdownNumber--,this.countdownStartTime=t,this.countdownNumber<1)){this.gameState="PLAYING",this.resumingFromPause||this.resetBall(),this.resumingFromPause=!1;return}const h=i/e;let s=1;if(h<.5)s=2-h*2;else{const l=(h-.5)*2;s=1-l*l*.2}const a=Math.ceil(5*s),o=Math.ceil(7*s),r=Math.floor(this.width/2)-Math.floor(a/2),c=Math.floor(this.height/2)-Math.floor(o/2);this.drawNumber(r,c,this.countdownNumber,s)}_getBlinkOn(){const t=performance.now();if(!this._blinkSnapshot||t-this._blinkSnapshot.at>BLINK_CACHE_MS){const i=t*BLINK_SPEED%1;this._blinkSnapshot={at:t,on:i<BLINK_ON_THRESHOLD}}return this._blinkSnapshot.on}_canDrawPixel(t,i,e={}){const h=Math.floor(this.width/2);if(t===h||i===0||i===this.height-1)return!1;if(e.excludeButton){const s=Math.floor(this.height/2);if(t>this.width-BUTTON_PADDING&&i>s-BUTTON_PADDING_V&&i<s+BUTTON_PADDING_V)return!1}return!0}drawFrame(t,i,e,h=!1){if(h&&!this._getBlinkOn())return;const s=Math.floor(this.width/2);this.display.drawRectOutline(t,i,e,e,{preserve:(a,o)=>a===s||o===0||o===this.height-1})}drawButtonFrame(t,i,e){this.drawFrame(t,i,e,!0)}drawPlayer1Frame(){const t=BUTTON_SIZE,i=this.player1FrameX,e=this.player1FrameY;this.drawFrame(i,e,t,!0);const h=SCALE_1P,s=1,a=i+s-1,o=e+s+2,r=Math.ceil(5*h);this.display.drawPattern(PIXEL_FONT[1],a,o,h),this.display.drawPattern(LARGE_LETTER_PATTERNS.P,a+r+1,o,h)}drawStartArrow(){const t=Math.floor(this.width/2),i=Math.floor(this.height/2),e=BUTTON_SIZE,h=this.startButtonFrameX,s=this.startButtonFrameY,a=h+5,o=s+5,r=s+e-5,c=h+e-5,l=o+Math.floor((r-o)/2),d=r-o;for(let n=o;n<=r;n++){const u=Math.abs(n-l),f=c-a,m=Math.max(1,Math.floor(f*(1-u/(d/2))));for(let g=a;g<a+m;g++)g>=h&&g<h+e&&n>=s&&n<s+e&&g>=0&&g<this.width&&n>=0&&n<this.height&&this._canDrawPixel(g,n)&&this.display.setPixel(g,n,!0)}this.drawButtonFrame(h,s,e),this.startButtonBounds={x:h,y:s,width:e,height:e}}drawRestartArrow(){const t=Math.floor(this.width/2),i=Math.floor(this.height/2),e=BUTTON_SIZE,s=t+Math.floor((this.width-t)/2)-Math.floor(e/2),a=i-Math.floor(e/2);this.restartArrowRotation+=this.restartArrowRotationSpeed,this.restartArrowRotation>=Math.PI*2&&(this.restartArrowRotation-=Math.PI*2);const o=s+Math.floor(e/2),r=a+Math.floor(e/2),c=RESTART_ARROW_RADIUS;for(let f=0;f<Math.PI*1.5;f+=.15){const m=f+this.restartArrowRotation,g=Math.round(o+Math.cos(m)*c),y=Math.round(r+Math.sin(m)*c);if(g>=s&&g<s+e&&y>=a&&y<a+e&&g>=0&&g<this.width&&y>=0&&y<this.height&&g!==t&&y!==0&&y!==this.height-1)for(let E=-1;E<=1;E++)for(let M=-1;M<=1;M++){const _=g+E,p=y+M;_>=s&&_<s+e&&p>=a&&p<a+e&&_>=0&&_<this.width&&p>=0&&p<this.height&&this._canDrawPixel(_,p)&&this.display.setPixel(_,p,!0)}}const l=Math.PI*1.5+this.restartArrowRotation,d=Math.round(o+Math.cos(l)*(c+2)),n=Math.round(r+Math.sin(l)*(c+2)),u=l+Math.PI/6;for(let f=0;f<3;f++){const m=u+f*Math.PI/3,g=u-f*Math.PI/3,y=Math.round(d+Math.cos(m)*f),E=Math.round(n+Math.sin(m)*f),M=Math.round(d+Math.cos(g)*f),_=Math.round(n+Math.sin(g)*f);for(const[p,S]of[[y,E],[M,_],[d,n]])p>=s&&p<s+e&&S>=a&&S<a+e&&p>=0&&p<this.width&&S>=0&&S<this.height&&this._canDrawPixel(p,S)&&this.display.setPixel(p,S,!0)}this.drawButtonFrame(s,a,e),this.restartButtonBounds={x:s,y:a,width:e,height:e}}drawBouncingPongTitle(){this.pongTitleX+=this.pongTitleVx,this.pongTitleY+=this.pongTitleVy;const t=28,i=14;this.pongTitleX<t/2?(this.pongTitleX=t/2,this.pongTitleVx=-this.pongTitleVx):this.pongTitleX>this.width-t/2&&(this.pongTitleX=this.width-t/2,this.pongTitleVx=-this.pongTitleVx),this.pongTitleY<i/2+1?(this.pongTitleY=i/2+1,this.pongTitleVy=-this.pongTitleVy):this.pongTitleY>this.height-i/2-1&&(this.pongTitleY=this.height-i/2-1,this.pongTitleVy=-this.pongTitleVy);const e=["P","O","N","G"],h=7,s=2,a=Math.floor(this.pongTitleX-e.length*h*s/2),o=Math.floor(this.pongTitleY-9*s/2);for(let r=0;r<e.length;r++){const c=LARGE_LETTER_PATTERNS[e[r]];c&&this.display.drawPattern(c,a+r*h*s,o,s)}}drawSmallTriangle(t,i,e,h){const s=SMALL_TRIANGLE_LONG_SIDE,a=SMALL_TRIANGLE_HEIGHT;if(e==="up")for(let o=0;o<a;o++){const r=s-(a-1-o)*2;if(r>0){const c=t-Math.floor(r/2);for(let l=0;l<r;l++){const d=c+l,n=i-a+o;if(d>=0&&d<this.width&&n>=0&&n<this.height&&this._canDrawPixel(d,n)){const u=o===0||o===a-1||l===0||l===r-1;(h||u)&&this.display.setPixel(d,n,!0)}}}}else for(let o=0;o<a;o++){const r=s-o*2;if(r>0){const c=t-Math.floor(r/2);for(let l=0;l<r;l++){const d=c+l,n=i+o;if(d>=0&&d<this.width&&n>=0&&n<this.height&&this._canDrawPixel(d,n)){const u=o===0||o===a-1||l===0||l===r-1;(h||u)&&this.display.setPixel(d,n,!0)}}}}}drawPlayer2Frame(){const t=BUTTON_SIZE,i=this.player2FrameX,e=this.player2FrameY;this.drawFrame(i,e,t,!0);const h=i+Math.floor(t/2),s=e-TRIANGLE_OFFSET-TRIANGLE_EXTRA,a=e+t+TRIANGLE_OFFSET+TRIANGLE_EXTRA,r=Math.max(0,["2P",1,2,3].indexOf(this.rightPlayerOption)),c=r<3,l=r>0;if(this.drawSmallTriangle(h,s,"up",c),this.drawSmallTriangle(h,a,"down",l),this.rightPlayerOption==="2P"){const d=SCALE_1P,n=1,u=i+n-1+2,f=e+n+2,m=SCALE_2P_DIGIT,g=Math.ceil(5*m);this.display.drawPattern(PIXEL_FONT[2],u,f,m),this.display.drawPattern(LARGE_LETTER_PATTERNS.P,u+g+1,f,d)}else{const d=this.aiDifficultyLevel,n=5,u=2,f=i+Math.floor((t-n*u)/2),m=e+Math.floor((t-7*u)/2);this.display.drawPattern(PIXEL_FONT[d],f,m,u)}}drawMenu(){this.drawBouncingPongTitle(),this.drawPlayer1Frame(),this.drawStartArrow(),this.drawPlayer2Frame()}drawEmojiFace(t,i,e,h=7){const a={smiley:[[0,1,1,1,1,1,0],[1,0,0,0,0,0,1],[1,0,1,0,1,0,1],[1,0,0,0,0,0,1],[1,0,1,0,1,0,1],[1,0,0,1,0,0,1],[0,1,1,0,1,1,0]],winking:[[0,1,1,1,1,1,0],[1,0,0,0,0,0,1],[1,0,1,0,1,0,1],[1,0,0,0,0,0,1],[1,0,1,1,1,0,1],[1,0,0,1,0,0,1],[0,1,1,0,1,1,0]],frowny:[[0,1,1,1,1,1,0],[1,0,0,0,0,0,1],[1,0,1,0,1,0,1],[1,0,0,0,0,0,1],[1,0,1,0,1,0,1],[1,1,0,0,0,1,1],[0,0,1,1,1,0,0]],thumbsDown:[[0,0,1,1,1,0,0],[0,1,1,1,1,1,0],[0,1,1,1,1,1,0],[0,0,1,1,1,0,0],[0,0,0,1,0,0,0],[0,0,1,1,1,0,0],[0,1,1,1,1,1,0]],xMark:[[1,0,0,0,0,0,1],[0,1,0,0,0,1,0],[0,0,1,0,1,0,0],[0,0,0,1,0,0,0],[0,0,1,0,1,0,0],[0,1,0,0,0,1,0],[1,0,0,0,0,0,1]]}[e];if(a){for(let o=0;o<a.length;o++)for(let r=0;r<a[o].length;r++)if(a[o][r]===1){const c=t+r,l=i+o;c>=0&&c<this.width&&l>=0&&l<this.height&&this._canDrawPixel(c,l)&&this.display.setPixel(c,l,!0)}}}drawFirework(t,i,e,h){const s=8+Math.sin(e*.01+h)*3,a=8;for(let o=0;o<a;o++){const r=o/a*Math.PI*2+e*.002,c=s;for(let l=0;l<c;l+=.5){const d=Math.round(t+Math.cos(r)*l),n=Math.round(i+Math.sin(r)*l);d>=0&&d<this.width&&n>=0&&n<this.height&&this._canDrawPixel(d,n)&&this.display.setPixel(d,n,!0)}}for(let o=-1;o<=1;o++)for(let r=-1;r<=1;r++){const c=t+o,l=i+r;c>=0&&c<this.width&&l>=0&&l<this.height&&this._canDrawPixel(c,l)&&this.display.setPixel(c,l,!0)}}_getGameOverMessage(){const t=this.rightPlayerOption==="2P",i=this.winner==="left"||this.winning===!0;return this.gameOverViaDebugKey?this.debugGameOverVariant||i?"WINNER!":"YOU LOSE":t||i?"WINNER!":"YOU LOSE"}_shouldShow2PLabel(){return this.rightPlayerOption==="2P"&&(this.winner==="left"||this.winner==="right")||this.gameOverViaDebugKey&&(this.debugGameOverVariant==="1P"||this.debugGameOverVariant==="2P")}drawGameOverMessage(){const i=performance.now()-this.gameOverStartTime,e=Math.floor(this.width/2),h=Math.floor(this.height/2),s=this._getGameOverMessage(),a=GAME_OVER_CHAR_WIDTH,o=s.length*a,r=Math.sin(i*GAME_OVER_BOUNCE_SPEED)*GAME_OVER_BOUNCE_AMOUNT,l=h-GAME_OVER_BASE_Y_OFFSET+r,d=e-Math.floor(o/2)+(s==="WINNER!"?GAME_OVER_WINNER_X_OFFSET:GAME_OVER_LOSE_X_OFFSET),n=LARGE_LETTER_PATTERNS;let u=0;for(const f of s){if(f===" "){u++;continue}const m=n[f.toUpperCase()];if(m){const g=d+u*a,y=GAME_OVER_TEXT_SCALE;for(let E=0;E<9;E++)for(let M=0;M<7;M++)if(m[E]&&m[E][M]===1)for(let _=0;_<y;_++)for(let p=0;p<y;p++){const S=Math.floor(g+M*y+p),P=Math.floor(l+E*y+_);S>=0&&S<this.width&&P>=0&&P<this.height&&this._canDrawPixel(S,P,{excludeButton:!0})&&this.display.setPixel(S,P,!0)}}u++}if(this._shouldShow2PLabel()){const m=(this.debugGameOverVariant||(this.winner==="left"?"1P":"2P"))[0],g=Math.floor(this.height/2)+Math.floor(this.height/2/2),y=Math.sin(i*LABEL_BOUNCE_SPEED)*LABEL_BOUNCE_AMOUNT,E=g+y,M=LABEL_SCALE,_=Math.ceil(LABEL_GLYPH_COLS*M),p=LABEL_GAP_W,S=_+p+_;let P=e-Math.floor(S/2);const v=(A,G)=>{if(A){for(let w=0;w<9;w++)for(let x=0;x<7;x++)if(A[w]&&A[w][x]===1)for(let b=0;b<M;b++)for(let L=0;L<M;L++){const T=Math.floor(G+x*M+L),O=Math.floor(E+w*M+b);T>=0&&T<this.width&&O>=0&&O<this.height&&this._canDrawPixel(T,O,{excludeButton:!0})&&this.display.setPixel(T,O,!0)}}};v(n[m],P),v(n.P,P+_+p)}}drawGameOver(){this.drawGameOverMessage(),this.drawRestartArrow()}checkButtonClick(t,i){if(this.gameState==="MENU"&&this.startButtonBounds){if(t>=this.startButtonBounds.x&&t<this.startButtonBounds.x+this.startButtonBounds.width&&i>=this.startButtonBounds.y&&i<this.startButtonBounds.y+this.startButtonBounds.height)return this.startNewGame(),!0}else if(this.gameState==="GAME_OVER"&&this.restartButtonBounds&&t>=this.restartButtonBounds.x&&t<this.restartButtonBounds.x+this.restartButtonBounds.width&&i>=this.restartButtonBounds.y&&i<this.restartButtonBounds.y+this.restartButtonBounds.height)return this.goToMenu(),!0;return!1}goToMenu(){this.gameState="MENU",this.winner=null,this.winning=!1,this.gameOverViaDebugKey=!1,this.debugGameOverVariant=null,this.gameOverStartTime=0,this.pongTitleX=Math.floor(this.width/2),this.pongTitleY=Math.floor(this.height/2),this.pongTitleVx=(Math.random()>.5?1:-1)*.5,this.pongTitleVy=(Math.random()>.5?1:-1)*.5}calculateAISkill(){let t;if(this.aiDifficultyLevel===1)t=.2;else if(this.aiDifficultyLevel===2)t=.5;else{t=.8;const i=2,h=.15/(i-1);t=.8+Math.min(this.currentSpeedMultiplier-1,i-1)*h,t=Math.min(t,.95)}return t}updateAIControllerSkill(){const t=this.calculateAISkill();this.rightController.skill=t}startNewGame(){this.score.left=0,this.score.right=0,this.volleyCount=0,this.currentSpeedMultiplier=1,this.leftPaddle.y=Math.floor(this.height/2-this.PADDLE_HEIGHT/2),this.rightPaddle.y=Math.floor(this.height/2-this.PADDLE_HEIGHT/2),this.ball.x=Math.floor(this.width/2),this.ball.y=Math.floor(this.height/2),this.ball.vx=0,this.ball.vy=0,this.ball.spin=0,this.updateScores(),this.rightPlayerOption==="2P"?(this.leftController=this._keyboardLeft2P,this.rightController=this._keyboardRight2P):(this.leftController=this._keyboard1P,this.rightController=this._aiController,this.updateAIControllerSkill()),this.gameState="COUNTDOWN",this.countdownNumber=3,this.countdownStartTime=performance.now(),this.winner=null,this.winning=!1,this.gameOverViaDebugKey=!1,this.debugGameOverVariant=null,this.gameOverStartTime=0}checkGameEnd(){this.score.left>=5?(this.winner="left",this.gameState="GAME_OVER",this.gameOverStartTime=performance.now(),this.ball.vx=0,this.ball.vy=0):this.score.right>=5&&(this.winner="right",this.gameState="GAME_OVER",this.gameOverStartTime=performance.now(),this.ball.vx=0,this.ball.vy=0)}setupPauseHandler(){typeof document>"u"||document.addEventListener("keydown",t=>{(KEY_PAUSE.includes(t.key)||t.keyCode===80)&&(t.preventDefault(),this.gameState==="PLAYING"?this.pauseGame():this.gameState==="PAUSED"&&this.unpauseGame())})}pauseGame(){this.savedState={ball:{x:this.ball.x,y:this.ball.y,vx:this.ball.vx,vy:this.ball.vy,spin:this.ball.spin},leftPaddle:{y:this.leftPaddle.y},rightPaddle:{y:this.rightPaddle.y},score:{left:this.score.left,right:this.score.right}},this.gameState="PAUSED",this.pauseButtonScale=1}unpauseGame(){this.savedState&&(this.ball.x=this.savedState.ball.x,this.ball.y=this.savedState.ball.y,this.ball.vx=this.savedState.ball.vx,this.ball.vy=this.savedState.ball.vy,this.ball.spin=this.savedState.ball.spin??0,this.leftPaddle.y=this.savedState.leftPaddle.y,this.rightPaddle.y=this.savedState.rightPaddle.y,this.score.left=this.savedState.score.left,this.score.right=this.savedState.score.right,this.updateScores()),this.resumingFromPause=!0,this.gameState="COUNTDOWN",this.countdownNumber=3,this.countdownStartTime=performance.now(),this.savedState=null}drawPauseButton(){const t=performance.now();this.pauseButtonScale=1+Math.sin(t*PAUSE_BOUNCE_SPEED)*PAUSE_BOUNCE_AMOUNT;const i=Math.floor(this.width/2),e=Math.floor(this.height/2),h=PAUSE_BAR_WIDTH,s=PAUSE_BAR_HEIGHT,a=PAUSE_BAR_SPACING,o=Math.floor(h*this.pauseButtonScale),r=Math.floor(s*this.pauseButtonScale),c=o*2+a,l=i-Math.floor(c/2),d=l+o+a,n=e-Math.floor(r/2);for(let u=0;u<r;u++)for(let f=0;f<o;f++){const m=l+f,g=n+u;m>=0&&m<this.width&&g>=0&&g<this.height&&this._canDrawPixel(m,g)&&this.display.setPixel(m,g,!0)}for(let u=0;u<r;u++)for(let f=0;f<o;f++){const m=d+f,g=n+u;m>=0&&m<this.width&&g>=0&&g<this.height&&this._canDrawPixel(m,g)&&this.display.setPixel(m,g,!0)}}setupClickHandler(){const t=this.display.canvas;typeof document>"u"||!t||typeof t.addEventListener!="function"||(t.addEventListener("click",i=>{const e=t.getBoundingClientRect(),h=i.clientX-e.left,s=i.clientY-e.top,a=Math.floor(h/t.width*this.width),o=Math.floor(s/t.height*this.height);this.checkButtonClick(a,o)}),document.addEventListener("keydown",i=>{if(i.key===KEY_DEGAUSS||i.keyCode===32){i.preventDefault(),this.display&&typeof this.display.degauss=="function"&&this.display.degauss();return}if(i.key===KEY_ENTER||i.keyCode===13)i.preventDefault(),this.gameState==="MENU"?this.startNewGame():this.gameState==="GAME_OVER"&&this.goToMenu();else if(this.gameState==="MENU"&&(KEY_MENU_UP.includes(i.key)||KEY_MENU_DOWN.includes(i.key))){i.preventDefault();const e=KEY_MENU_UP.includes(i.key),h=KEY_MENU_DOWN.includes(i.key),s=["2P",1,2,3];let a=s.indexOf(this.rightPlayerOption);a===-1&&(a=1),e&&a<3?a++:h&&a>0&&a--,this.rightPlayerOption=s[a],this.aiDifficultyLevel=this.rightPlayerOption==="2P"?1:this.rightPlayerOption,this.rightPlayerOption!=="2P"&&this.updateAIControllerSkill()}}))}drawCurrentFrame(t,i){const e=t??1,h=i?i.leftPaddle.y+(this.leftPaddle.y-i.leftPaddle.y)*e:this.leftPaddle.y,s=i?i.rightPaddle.y+(this.rightPaddle.y-i.rightPaddle.y)*e:this.rightPaddle.y,a=i?i.ball.x+(this.ball.x-i.ball.x)*e:this.ball.x,o=i?i.ball.y+(this.ball.y-i.ball.y)*e:this.ball.y;this.display.drawRectFilled(this.PADDLE_LEFT_X,Math.floor(h),this.PADDLE_WIDTH,this.PADDLE_HEIGHT),this.display.drawRectFilled(this.PADDLE_RIGHT_X,Math.floor(s),this.PADDLE_WIDTH,this.PADDLE_HEIGHT);const r=Math.floor(a),c=Math.floor(o);r>=0&&r<this.width&&c>=0&&c<this.height&&this.display.drawRectFilled(r,c,1,1)}getSpinConfig(){const t=this.rightPlayerOption!=="2P"&&this.aiDifficultyLevel===3?LEVEL_SPEED_FACTOR_3:1;if(this.rightPlayerOption==="2P")return{paddleTransfer:SPIN_PADDLE_TRANSFER_2P,magnusFactor:SPIN_MAGNUS_FACTOR_2P,dampingPerTick:SPIN_DAMPING_PER_TICK,wallRetention:SPIN_WALL_RETENTION_2P,maxSpin:SPIN_MAX,speedFactor:1};const i=this.aiDifficultyLevel-1;return{paddleTransfer:SPIN_PADDLE_TRANSFER_LEVEL[i],magnusFactor:SPIN_MAGNUS_FACTOR_LEVEL[i],dampingPerTick:SPIN_DAMPING_PER_TICK,wallRetention:SPIN_WALL_RETENTION_LEVEL[i],maxSpin:SPIN_MAX,speedFactor:t}}updatePaddle(t,i){if(t._prevY=t.y,i instanceof AIController)this.updateAIControllerSkill(),i.update(t,this.ball,{score:this.score,width:this.width,height:this.height,speedMultiplier:this.currentSpeedMultiplier,degaussStartTime:this.display.degaussStartTime,degaussDuration:this.display.degaussDuration,currentTime:performance.now(),aiDifficultyLevel:this.aiDifficultyLevel});else{const e=i.update(t,this.ball,{score:this.score,width:this.width,height:this.height});e==="up"?t.y-=t.speed:e==="down"&&(t.y+=t.speed)}t.y<1&&(t.y=1),t.y+t.height>this.height-1&&(t.y=this.height-1-t.height),t.vy=t.y-t._prevY,t._prevY=t.y}checkPaddleCollision(t){const i=this.ball.x,e=this.ball.y;if(i>=t.x&&i<t.x+t.width&&e>=t.y&&e<t.y+t.height){const h=(e-t.y)/t.height;this.volleyCount++;const s=Math.min(1+this.volleyCount*SPEED_INCREASE_PER_VOLLEY,MAX_SPEED_MULTIPLIER);this.currentSpeedMultiplier=s;const a=this.getSpinConfig(),o=a.paddleTransfer*t.vy;this.ball.spin=Math.max(-a.maxSpin,Math.min(a.maxSpin,this.ball.spin+o)),this.ball.vx=-this.ball.vx*s*a.speedFactor;const r=(h-.5)*2,c=Math.abs(r*this.BALL_SPEED*.8);return this.ball.vy=(r>=0?1:-1)*c*s*a.speedFactor,Math.abs(this.ball.vx)<.5&&(this.ball.vx=this.ball.vx>0?.5:-.5),!0}return!1}updateBall(){const t=this.getSpinConfig();this.ball.vy+=this.ball.spin*t.magnusFactor,this.ball.spin*=t.dampingPerTick,this.ball.x+=this.ball.vx,this.ball.y+=this.ball.vy,this.ball.y<=1&&(this.ball.y=1,this.ball.vy=-this.ball.vy,this.ball.spin*=t.wallRetention),this.ball.y>=this.height-2&&(this.ball.y=this.height-2,this.ball.vy=-this.ball.vy,this.ball.spin*=t.wallRetention),this.checkPaddleCollision(this.leftPaddle),this.checkPaddleCollision(this.rightPaddle),this.ball.x<0?(this.score.right++,this.updateScores(),this.volleyCount=0,this.currentSpeedMultiplier=1,this.resetBall()):this.ball.x>=this.width&&(this.score.left++,this.updateScores(),this.volleyCount=0,this.currentSpeedMultiplier=1,this.resetBall())}resetBall(){this.ball.x=Math.floor(this.width/2),this.ball.y=Math.floor(this.height/2),this.ball.spin=0,this.volleyCount=0,this.currentSpeedMultiplier=1;const t=1+(Math.random()-.5)*.1,i=this.BALL_SPEED*t*this.getSpinConfig().speedFactor,e=Math.atan2(.7,1),h=(Math.random()-.5)*(10*Math.PI/180),s=e+h,a=Math.random()>.5?1:-1;this.ball.vx=a*i*Math.cos(s),this.ball.vy=i*Math.sin(s)}update(){this.maintainCourt();const t=this._runStateUpdate[this.gameState];if(t){t.call(this);return}}updateLogic(t){this.updatePaddle(this.leftPaddle,this.leftController),this.updatePaddle(this.rightPaddle,this.rightController),this.updateBall(),this.checkGameEnd()}}if(typeof document<"u"&&document.getElementById("display")){let o=function(r){e||(e=r);let c=Math.min(r-e,MAX_FRAME_MS);e=r,h+=c,i.gameState==="PLAYING"&&a!=="PLAYING"&&(h=0),a=i.gameState,t.clear();let l=null;if(i.gameState==="PLAYING"){i.maintainCourt();let f=0;for(;h>=DT_MS&&f<MAX_UPDATES_PER_FRAME;)l={ball:{x:i.ball.x,y:i.ball.y},leftPaddle:{y:i.leftPaddle.y},rightPaddle:{y:i.rightPaddle.y}},i.updateLogic(DT_MS),h-=DT_MS,f++;l==null&&(l={ball:{x:i.ball.x,y:i.ball.y},leftPaddle:{y:i.leftPaddle.y},rightPaddle:{y:i.rightPaddle.y}})}else i.update(DT_MS);const d=h/DT_MS,n=performance.now(),u=s!=null?n-s:0;i.gameState==="PLAYING"&&i.drawCurrentFrame(d,l),t.render(d,{now:n,dtSinceLastRender:u}),s=n,requestAnimationFrame(o)};var gameLoop=o;const D=document.getElementById("display"),t=new PixelDisplay(D,160,120,800,600),i=new Pong(t);let e=0,h=0,s,a=null;requestAnimationFrame(o)} </script> </body> </html>